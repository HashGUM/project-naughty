# 项目开发规则

## KISS原则（Keep It Simple, Stupid）

在验证阶段，简单性至关重要。

### 1. 核心原则

**简单 > 复杂**
- ✅ 直接解决问题
- ❌ 过度设计
- ❌ 不必要的抽象层
- ❌ "未来可能需要"的功能

### 2. 代码规范

#### ✅ 好的做法

```gdscript
# 配置直接放在使用的地方
const SYSTEM_PROMPT = """提示词..."""

func _ready():
    llama.call("set_system_prompt", SYSTEM_PROMPT)
```

#### ❌ 避免的做法

```gdscript
# 不要创建不必要的管理器类
class PromptManager:
    static func configure(...): ...
    static func validate(...): ...
    static func transform(...): ...
```

### 3. 文件组织

#### ✅ 简单结构

```
scripts/
  ├── ai_controller_3d.gd  # 所有AI配置在这里
  ├── cat_3d.gd            # 猫咪逻辑
  └── main_3d.gd           # 主控制
```

#### ❌ 过度分离

```
scripts/
  ├── ai/
  │   ├── prompt_manager.gd
  │   ├── grammar_validator.gd
  │   ├── config_loader.gd
  │   └── prompt_factory.gd  # 不需要！
  └── ...
```

### 4. 功能开发

#### 验证阶段优先级

1. **能用** - 功能正常工作
2. **简单** - 代码易理解
3. **快速** - 快速迭代测试
4. ~~完美~~ - 不追求完美

#### 迭代原则

```
实现 → 测试 → 工作了？
         ↓ 是
       保持简单，继续下一个
         ↓ 否
       修复（保持简单）
```

### 5. 重构时机

**何时重构：**
- ✅ 同样的代码复制了3次以上
- ✅ 函数超过50行且难以理解
- ✅ 类超过500行且职责不清

**何时不重构：**
- ❌ "可能将来会用到"
- ❌ "这样更优雅"
- ❌ "设计模式说应该..."

### 6. 文档原则

**写文档的时机：**
- ✅ 功能完成并测试通过
- ✅ 有不明显的使用方式
- ✅ 用户会直接使用的API

**不写文档的时机：**
- ❌ 代码还在频繁变动
- ❌ 只是内部实现细节
- ❌ 代码本身已经足够清晰

### 7. 依赖管理

**添加依赖的标准：**
- ✅ 显著减少开发时间
- ✅ 经过充分测试
- ✅ 维护活跃

**不添加依赖：**
- ❌ 只用到1-2个功能
- ❌ 自己写只需要20行代码
- ❌ "看起来很酷"

### 8. 测试策略

**验证阶段测试：**
- ✅ 手动测试核心功能
- ✅ 边界情况测试
- ❌ 不写单元测试（此阶段）
- ❌ 不追求100%覆盖率

**何时写自动化测试：**
- 核心功能稳定后
- 发现重复出现的bug
- 准备发布时

### 9. 性能优化

**优化原则：**
1. 先让它工作
2. 测量性能
3. 发现瓶颈
4. 优化瓶颈
5. 重新测量

**不要做的：**
- ❌ 过早优化
- ❌ 猜测瓶颈
- ❌ 牺牲可读性换取微小提升

### 10. 实际案例

#### 案例1：提示词管理

**❌ 过度设计（已移除）：**
```gdscript
# 创建了230行的PromptManager
class PromptManager:
    const CONFIGS = {...}
    static func configure_llama(...): ...
    static func configure_custom(...): ...
    static func clear_config(...): ...
    static func list_configs(): ...
    # ... 更多方法
```

**✅ KISS方案（当前）：**
```gdscript
# 直接在ai_controller_3d.gd中
const SYSTEM_PROMPT = """..."""
const JSON_GRAMMAR = """..."""

llama.call("set_system_prompt", SYSTEM_PROMPT)
llama.call("set_grammar_content", JSON_GRAMMAR)
```

**结果：** 减少230行代码，更清晰，更易维护。

#### 案例2：配置方式

**❌ 复杂：**
- 4种配置方式
- 预设配置字典
- 文件/内联混合
- 动态切换
- A/B测试框架

**✅ 简单：**
- 2种方式：直接配置 或 文件默认
- 够用了！

### 11. 检查清单

在添加新功能前问自己：

- [ ] 这是现在必需的吗？
- [ ] 能用最简单的方式实现吗？
- [ ] 会增加多少复杂度？
- [ ] 删除它会影响核心功能吗？

如果前两个是"否"，后两个是"很多"和"不会"，那就**不要做**。

### 12. 技术债务

**什么时候偿还：**
- 功能验证完成
- 准备扩展时
- 有足够的测试覆盖

**验证阶段：**
- ⚠️ 允许存在技术债务
- ⚠️ 但要记录下来
- ✅ 保持代码可读

### 13. 代码审查标准

**通过标准：**
- ✅ 功能正常
- ✅ 代码可读
- ✅ 无明显bug

**不必要的要求：**
- ❌ 完美的设计模式
- ❌ 100%测试覆盖
- ❌ 性能极限优化
- ❌ 支持所有边缘情况

---

## 总结

**验证阶段的唯一目标：快速验证想法是否可行**

- 简单的代码 > 优雅的代码
- 工作的功能 > 完美的功能
- 快速迭代 > 一次做对

**记住：过早的优化和抽象是万恶之源！**

---

*这些规则在项目进入生产阶段后可以调整。*

